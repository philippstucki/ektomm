#!/usr/bin/env php
<?php

require_once('vendor/swiftmailer/lib/swift_required.php');

if (empty($argv[1]) || !is_readable($argv[1])) {
    die('Usage: ektomm-send campaign'.PHP_EOL);
}

require($argv[1]);

//Create the Transport
$transport = Swift_SmtpTransport::newInstance($config['host'], $config['port'])
  ->setUsername($config['username'])
  ->setPassword($config['password']);

//Create the Mailer using your created Transport
$mailer = Swift_Mailer::newInstance($transport);

fwrite(STDERR, "Starting to send...\n");
$msgs = 0;

while (FALSE !== ($line = fgets(STDIN))) {

    $to = trim($line);
    if($to !== '') {

        //Create a message
        $message = Swift_Message::newInstance($config['subject'])
          ->setFrom($config['from'])
          ->setTo(array($to))
          ->setBody($config['txtBody'])
          ;

        //Send the message
        $result = $mailer->send($message);

        if($result === 1) {
            $msgs++;
            fwrite(STDERR, "sent to {$to}".PHP_EOL);
            fwrite(STDOUT, $to.PHP_EOL);
        }
    }
}

fwrite(STDERR, "Sent {$msgs} messages\n");


